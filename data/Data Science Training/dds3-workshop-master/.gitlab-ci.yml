image: docker:latest

stages:
  - build
  - test
  - push
  - post

variables:
  SINGLEUSER_CACHE: "registry.gitlab.com/windtrain/dds3-workshop:latest"
  SINGLEUSER_IMG: "eu.gcr.io/dds-platform/dds3-singleuser"
  DOCKER_DRIVER: overlay

singleuser-build:
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
  script:
    - docker pull ${SINGLEUSER_CACHE} || true # Pull for cache, ignore if it doesn't exist
    - docker build --cache-from ${SINGLEUSER_CACHE} -t ${SINGLEUSER_CACHE} -f ./Dockerfile .
    - docker push ${SINGLEUSER_CACHE} # Update cache image

test-notebook:
  stage: test
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
  script:
    - docker run -i -v $PWD:/home/jovyan ${SINGLEUSER_CACHE} py.test --nbval-lax

test-code:
  stage: test
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
  script:
    - docker run -i -v $PWD/answers:/home/jovyan ${SINGLEUSER_CACHE} python3 -m unittest discover -p '*_test.py'

singleuser-push:
  stage: push
  services:
    - docker:dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
  only:
    - master
  script:
    - export SINGLEUSER_SHA="${SINGLEUSER_IMG}:${CI_COMMIT_SHA:0:8}"
    - docker pull ${SINGLEUSER_CACHE}
    - docker tag ${SINGLEUSER_CACHE} ${SINGLEUSER_SHA}
    - echo ${GCLOUD_SERVICE_ACCOUNT_JSON} > key_64
    - base64 -d key_64 > key.json
    - docker login -u _json_key -p "$(cat key.json)" https://eu.gcr.io
    - docker push ${SINGLEUSER_SHA}

permissions:
  image: google/cloud-sdk:alpine
  stage: post
  script:
    - echo ${GCLOUD_SERVICE_ACCOUNT_JSON} > key_64
    - base64 -d key_64 > key.json
    - gcloud auth activate-service-account --key-file key.json
    - gsutil -m acl ch -r -u AllUsers:READ gs://eu.artifacts.dds-platform.appspot.com/
  only:
    - master